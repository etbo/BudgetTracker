@using BlazorApp.Data
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db

@rendermode InteractiveServer

<h2>Bilan du nombre d'opérations par mois</h2>

@if (Stats == null)
{
    <p>Chargement...</p>
}
else if (!Stats.Any())
{
    <p>Aucune opération trouvée.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Mois</th>
                <th>Nombre d'opérations Fortuneo</th>
                <th>Nombre d'opérations CA</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in Stats)
            {
                var css = s.Nombre == 0 ? "text-danger" : "";

                <tr>
                    <td class="@css">@s.MoisNom @s.Annee</td>
                    <td class="@css">@s.NombreFortuneo</td>
                    <td class="@css">@s.NombreCA</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    // Lecture de la BDD :
    
    
    public List<OpsParMois> Stats { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Bornes pour l'affichage du tableau
        var dateDebut = DateTime.Today.AddYears(-2);//new DateTime(2020, 1, 1);
        var dateFin = DateTime.Today.AddMonths(-1);

        // 1. Charger les opérations et parser les dates
        var operations = Db.Operations
            .Select(op => new 
            {
                Date = DateTime.Parse(op.Date),
                Banque = op.Banque
            })
            .ToList();

        // 2. Générer tous les mois entre dateDebut et aujourd’hui
        var tousLesMois = new List<(int Annee, int Mois)>();
        var d = new DateTime(dateDebut.Year, dateDebut.Month, 1);

        while (d <= dateFin)
        {
            tousLesMois.Add((d.Year, d.Month));
            d = d.AddMonths(1);
        }

        // 3. Compter les opérations par mois
        var opsBanqueFortuneo = operations
            .Where(op => op.Banque == "Fortuneo")
            .Select(op => op.Date)
            .GroupBy(x => new { x.Date.Year, x.Date.Month })
            .ToDictionary(
                g => (g.Key.Year, g.Key.Month),
                g => g.Count()
            );

        var opsBanqueCA = operations
            .Where(op => op.Banque == "CA")
            .Select(op => op.Date)
            .GroupBy(x => new { x.Date.Year, x.Date.Month })
            .ToDictionary(
                g => (g.Key.Year, g.Key.Month),
                g => g.Count()
            );

        // 4. Fusionner → mois sans opérations = 0
        Stats = tousLesMois
            .Select(m => new OpsParMois
            {
                Annee = m.Annee,
                Mois = m.Mois,
                NombreFortuneo = opsBanqueFortuneo.TryGetValue((m.Annee, m.Mois), out var c1) ? c1 : 0,
                NombreCA = opsBanqueCA.TryGetValue((m.Annee, m.Mois), out var c2) ? c2 : 0,
                MoisNom = CultureInfo.GetCultureInfo("fr-FR").DateTimeFormat.GetMonthName(m.Mois)
            })
            .OrderByDescending(x => x.Annee)
            .ThenByDescending(x => x.Mois)
            .ToList();

    }

    public class OpsParMois
    {
        public int Annee { get; set; }
        public int Mois { get; set; }
        public int Nombre { get; set; }
        public int NombreFortuneo { get; set; }
        public int NombreCA { get; set; }
        public string MoisNom { get; set; }
    }
}