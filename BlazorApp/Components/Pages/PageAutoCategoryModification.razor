@page "/autocategory"
@using BlazorApp.Data
@using BlazorApp.Services
@using System.Data
@using Microsoft.EntityFrameworkCore
@using System.Threading.Tasks

@inject DatabaseSelectorService DbSelector
@inject IDbContextFactory<AppDbContext> DbFactory
@inject CategoryService CategoryService

@rendermode InteractiveServer

<h1>Liste des Cat√©gories</h1>

<p>Liste depuis la BDD. Editable (ajout, suppr ?, renommage)</p>
<p>Si renommage : rechercher remplacer dans les Cat√©gories de la BDD</p>

<table>
    <thead>
        <tr>
            <th>Cat√©gorie</th>
            <th>Type</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var cat in categories)
            {
                <tr>
                    <td>@cat.Name</td>
                    <td>@cat.Type</td>
                </tr>
            }
        <tr></tr>
    </tbody>
</table>

<h1>Liste des r√®gles pour la cat√©gorisation automatique</h1>

@if (IsLoading)
{
    <div class="alert alert-info">Chargement des op√©rations...</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Contient...</th>
                <th>Montant minimum</th>
                <th>Montant maximum</th>
                <th>Date d√©but</th>
                <th>Date fin</th>
                <th>Cat√©gorie associ√©e</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var rule in resultatRules)
            {
                <tr>
                    <td>
                        <input class="form-control" @bind-Value="rule.Pattern" @bind-Value:event="onchange"
                            @bind-Value:after="async () => await SaveRule(rule)" />
                    </td>
                    <td>
                        <InputNumber TValue="double?" @bind-Value="rule.MinAmount"
                            @bind-Value:after="async () => await SaveRule(rule)" class="form-control" />
                    </td>
                    <td>
                        <InputNumber TValue="double?" @bind-Value="rule.MaxAmount"
                            @bind-Value:after="async () => await SaveRule(rule)" class="form-control" />
                    </td>
                    <td>
                        <InputDate TValue="DateTime ?" @bind-Value="rule.MinDate"
                            @bind-Value:after="async () => await SaveRule(rule)" class="form-control" />
                    </td>
                    <td>
                        <InputDate TValue="DateTime ?" @bind-Value="rule.MaxDate"
                            @bind-Value:after="async () => await SaveRule(rule)" class="form-control" />
                    </td>
                    <td class="text-primary">
                        <select class="form-select" value="@rule.Category" @onchange="e => OnCategoryChanged(e, rule)">
                            <option value=""></option>
                            @foreach (var cat in categories)
                            {
                                <option value="@cat.Name">@cat.Name</option>
                            }
                        </select>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button class="btn btn-primary mb-3" @onclick="AddRule">
        Ajouter une r√®gle
    </button>
}


@code
{
    private bool IsLoading { get; set; } = false;

    public List<AutoCategoryRule> resultatRules { get; set; } = new();

    private List<Category> categories = new();

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategoriesAsync();

        await GetRules();

        // üî• On s‚Äôabonne pour √™tre notifi√© du changement
        DbSelector.OnChange += RefreshOnChange;
    }

    private async Task GetRules()
    {
        IsLoading = true;
        resultatRules = new List<AutoCategoryRule>();
        StateHasChanged(); // rafra√Æchi l‚ÄôUI imm√©diatement

        await Task.Run(() =>
        {
            using var db = DbFactory.CreateDbContext();

            resultatRules = db.AutoCategoryRules
    .ToList();
        });

        IsLoading = false;

        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshOnChange()
    {
        await GetRules();

        // üî• Important : on repasse sur le thread UI
        await InvokeAsync(StateHasChanged);
    }

    private async void AddRule()
    {
        using var db = DbFactory.CreateDbContext();

        var newRule = new AutoCategoryRule
        {
            Category = "",
            MinAmount = null,
            MaxAmount = null,
            Pattern = ""
        };

        // INSERT dans la base
        db.AutoCategoryRules.Add(newRule);
        await db.SaveChangesAsync();

        // EF met √† jour automatiquement newRule.Id üëç
        resultatRules.Add(newRule);
    }

    private async Task OnCategoryChanged(ChangeEventArgs e, AutoCategoryRule rule)
    {
        rule.Category = e.Value?.ToString();
        await SaveRule(rule);
    }

    private async Task SaveRule(AutoCategoryRule rule)
    {
        using var db = DbFactory.CreateDbContext();

        db.Attach(rule);
        db.Entry(rule).State = EntityState.Modified;

        await db.SaveChangesAsync();
    }


    public void Dispose()
    {
        // üî• Toujours se d√©sabonner pour √©viter les fuites m√©moire
        DbSelector.OnChange -= RefreshOnChange;
    }
}