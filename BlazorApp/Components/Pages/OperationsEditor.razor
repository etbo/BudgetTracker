@page "/operationseditor"
@using BlazorApp.Services
@rendermode InteractiveServer
@inject DatabaseSelectorService DbSelector


<h1>Edition d'opÃ©rations</h1>

<select class="form-select" @onchange="OnOptionChanged">
    <option value="A">OpÃ©rations avec Type manquant</option>
    <option value="B">Option B</option>
    <option value="C">Option C</option>
</select>

<p>Valeur = @SelectedValue</p>
<p>Base actuelle : @DbSelector.CurrentDatabase</p>

@code {
    private Dictionary<string, Action> actions;
    private string SelectedValue = "";

    protected override void OnInitialized()
    {
        actions = new Dictionary<string, Action>
        {
            { "A", FiltrerTypeManquant },
            { "B", DoTreatmentB },
            { "C", DoTreatmentC }
        };

        // ðŸ”¥ On sâ€™abonne pour Ãªtre notifiÃ© du changement
        DbSelector.OnChange += RefreshOnChange;
    }

    private void OnOptionChanged(ChangeEventArgs e)
    {
        if (e.Value is string key && actions.ContainsKey(key))
            actions[key].Invoke();
    }

    private void FiltrerTypeManquant()
    {
        SelectedValue = $"FiltrerTypeManquant (BDD {DbSelector.CurrentDatabase})";
    }

    private void DoTreatmentB()
    {
        SelectedValue = "B";

    }

    private void DoTreatmentC()
    {
        SelectedValue = "C";

    }

    private Task RefreshOnChange()
    {
        // ðŸ”¥ Important : on repasse sur le thread UI
        return InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // ðŸ”¥ Toujours se dÃ©sabonner pour Ã©viter les fuites mÃ©moire
        DbSelector.OnChange -= RefreshOnChange;
    }
}