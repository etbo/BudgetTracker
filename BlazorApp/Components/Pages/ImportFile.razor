@page "/importfiles"
@using System.Text
@inject BlazorApp.Data.Services.CompteCourantService CompteService
@rendermode InteractiveServer


<h1>Importer un fichier</h1>

<InputFile OnChange="HandleFileSelected" />

<p>@message</p>

@* <button class="btn btn-primary" @onclick="ImportData">Importer</button> *@


@code {
    private string message = "";

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        Console.WriteLine($"Taille fichier: {file.Size} octets");

        message = "En cours...";
        Console.WriteLine("\n-_-_-_-_-_-azerty-_-_-_-_-_");

        try
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream, System.Text.Encoding.UTF8);

            Console.WriteLine("Lecture du fichier...");
            var content = await reader.ReadToEndAsync();

            Console.WriteLine("Contenu lu !");
            message = $"Longueur du contenu: {content.Length}";

            // Déterminer banque → choisir bon parser
            var parser = BanqueCsvParserFactory.GetParser(content);

            Console.WriteLine("-_-_-_-_-_-_parser_-_-_-_-_-_");
            message = parser.ToString();

            Console.WriteLine(parser);
            // Parser et transformer données
            var Operations = parser.ParseCsv(new MemoryStream(Encoding.UTF8.GetBytes(content)));

            // Import en base
            foreach (var Operation in Operations)
            {
                await CompteService.AddAsync(Operation);
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"ERREUR CSV: {ex.Message}");
            message = $"Erreur: {ex.Message}";
        }

        
    }
}