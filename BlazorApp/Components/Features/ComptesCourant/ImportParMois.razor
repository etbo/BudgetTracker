@using BlazorApp.Data
@using BlazorApp.Services
@using Microsoft.EntityFrameworkCore
@inject DatabaseSelectorService DbSelector
@inject IDbContextFactory<AppDbContext> DbFactory

@rendermode InteractiveServer

@implements IDisposable


<h2>Bilan du nombre d'op√©rations par mois</h2>
<p></p>
@if (Stats == null)
{
    <p>Chargement...</p>
}
else if (!Stats.Any())
{
    <p>Aucune op√©ration trouv√©e.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Mois</th>
                <th>Nombre d'op√©rations Fortuneo</th>
                <th>Nombre d'op√©rations CA</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in Stats)
            {
                var css = s.Nombre == 0 ? "text-danger" : "";

                <tr>
                    <td class="@css">@s.MoisNom @s.Annee</td>
                    <td class="@css">@s.NombreFortuneo</td>
                    <td class="@css">@s.NombreCA</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    // Lecture de la BDD :

    private Guid _instanceId = Guid.NewGuid();
    public required List<OpsParMois> Stats { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine($"OnAfterRenderAsync ‚Üí Instance = {_instanceId}");

            DbSelector.OnChange -= RefreshOnChange;
            DbSelector.OnChange += RefreshOnChange;

            await CalculateStat();
            StateHasChanged();
        }
    }

    private async Task CalculateStat()
    {
        Console.WriteLine($"Calcul des stats");
        Console.WriteLine($"OnInitializedAsync ‚Üí Instance = {_instanceId}");
        // R√©cup√©ration de la DB :
        using var db = DbFactory.CreateDbContext();
        Console.WriteLine($"db = {db.Database.GetDbConnection().DataSource} ({DateTime.Now})");

        // Bornes pour l'affichage du tableau
        var dateDebut = DateTime.Today.AddYears(-2);//new DateTime(2020, 1, 1);
        var dateFin = DateTime.Today.AddMonths(-1);

        // 1. Charger les op√©rations et parser les dates
        var operations = await db.Operations
        .Select(op => new
        {
            Date = DateTime.Parse(op.Date),
            Banque = op.Banque
        })
        .ToListAsync();

        // 2. G√©n√©rer tous les mois entre dateDebut et aujourd‚Äôhui
        var tousLesMois = new List<(int Annee, int Mois)>();
        var d = new DateTime(dateDebut.Year, dateDebut.Month, 1);

        while (d <= dateFin)
        {
            tousLesMois.Add((d.Year, d.Month));
            d = d.AddMonths(1);
        }

        // 3. Compter les op√©rations par mois
        var opsBanqueFortuneo = operations
        .Where(op => op.Banque == "Fortuneo")
        .Select(op => op.Date)
        .GroupBy(x => new { x.Date.Year, x.Date.Month })
        .ToDictionary(
        g => (g.Key.Year, g.Key.Month),
        g => g.Count()
        );

        var opsBanqueCA = operations
        .Where(op => op.Banque == "CA")
        .Select(op => op.Date)
        .GroupBy(x => new { x.Date.Year, x.Date.Month })
        .ToDictionary(
        g => (g.Key.Year, g.Key.Month),
        g => g.Count()
        );

        // 4. Fusionner ‚Üí mois sans op√©rations = 0
        Stats = tousLesMois
        .Select(m => new OpsParMois
        {
            Annee = m.Annee,
            Mois = m.Mois,
            NombreFortuneo = opsBanqueFortuneo.TryGetValue((m.Annee, m.Mois), out var c1) ? c1 : 0,
            NombreCA = opsBanqueCA.TryGetValue((m.Annee, m.Mois), out var c2) ? c2 : 0,
            MoisNom = CultureInfo.GetCultureInfo("fr-FR").DateTimeFormat.GetMonthName(m.Mois)
        })
        .OrderByDescending(x => x.Annee)
        .ThenByDescending(x => x.Mois)
        .ToList();
    }

    public class OpsParMois
    {
        public int Annee { get; set; }
        public int Mois { get; set; }
        public int Nombre { get; set; }
        public int NombreFortuneo { get; set; }
        public int NombreCA { get; set; }
        public required string MoisNom { get; set; }
    }

    private async Task RefreshOnChange()
    {
        await CalculateStat();

        // üî• Important : on repasse sur le thread UI
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // üî• Toujours se d√©sabonner pour √©viter les fuites m√©moire
        DbSelector.OnChange -= RefreshOnChange;
    }
}