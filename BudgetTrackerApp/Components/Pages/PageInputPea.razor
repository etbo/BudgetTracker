@page "/InputPea"
@using BudgetTrackerApp.Data
@using BudgetTrackerApp.Models
@using BudgetTrackerApp.Services
@using Microsoft.EntityFrameworkCore

@rendermode InteractiveServer
@inject DatabaseSelectorService DbSelector
@inject IDbContextFactory<AppDbContext> DbFactory
@inject BudgetTrackerApp.Data.Services.PeaService PeaService

<MudText Typo="Typo.h4" Class="my-8">Saisie d'op√©ration sur le PEA</MudText>

<MudTable Items="@operationsPea" Dense="true" Hover="true" Bordered="false" Striped="true" >
    <HeaderContent>
        <MudTh>Date d'achat</MudTh>
        <MudTh>Titulaire</MudTh>
        <MudTh>Code</MudTh>
        <MudTh>Quantit√©</MudTh>
        <MudTh>Montant Brut</MudTh>
        <MudTh>Montant Net</MudTh>
        <MudTh>Frais</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudDatePicker Label=""
                           AutoClose="true"
                           Date="context.Date"
                           DateChanged="@(async (DateTime? newDate) => 
                           {
                               // Met √† jour la propri√©t√© de l'objet de contexte
                               context.Date = newDate;
                               
                               // Ex√©cute votre fonction de sauvegarde
                               await SaveOperationPea(context);
                           })" />
        </MudTd>
        <MudTd>
            <MudTextField @bind-Value="@context.Titulaire" Margin="Margin.Dense" Variant="Variant.Outlined"
                        OnBlur="() => SaveOperationPea(context)" />
        </MudTd>
        <MudTd>
            <MudTextField @bind-Value="@context.Code" Margin="Margin.Dense" Variant="Variant.Outlined"
                        OnBlur="() => SaveOperationPea(context)" />
        </MudTd>
        <MudTd>
            <MudNumericField @bind-Value="context.Quantit√©" Label="" Format="F0" Variant="Variant.Outlined" @bind-Value:after="async () => await SaveOperationPea(context)" />
        </MudTd>
        <MudTd>
            <MudNumericField @bind-Value="context.MontantBrutUnitaire" Label="" Format="F1" Variant="Variant.Outlined" @bind-Value:after="async () => await SaveOperationPea(context)" />            
        </MudTd>
        <MudTd>
            <MudNumericField @bind-Value="context.MontantNet" Label="" Format="F1" Variant="Variant.Outlined" @bind-Value:after="async () => await SaveOperationPea(context)" />
        </MudTd>
        <MudTd>
            @if (context.MontantNet > 0)
            {
                if (context.MontantNet > context.MontantBrutUnitaire)
                {
                    @(((context.MontantNet / context.MontantBrutUnitaire - 1) * 100).ToString("N2") + " %")
                }
                else
                {
                    @("-")
                }
            }

            
        </MudTd>
    </RowTemplate>
</MudTable>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddOperationPea" >Ajouter une op√©ration</MudButton>

@code
{
    private List<OperationPea> operationsPea = new();

    protected override async Task OnInitializedAsync()
    {
        // Gzet list of Categories for Select input
        operationsPea = await PeaService.GetAllOperationsAsync();

        // üî• On s‚Äôabonne pour √™tre notifi√© du changement
        DbSelector.OnChange += RefreshOnChange;
    }

    private async Task SaveOperationPea(OperationPea op)
    {
        Console.WriteLine("Save rule");
        using var db = DbFactory.CreateDbContext();

        db.Attach(op);
        db.Entry(op).State = EntityState.Modified;

        await db.SaveChangesAsync();
    }

    private async void AddOperationPea()
    {
        Console.WriteLine("Ajout op√©ration PEA");
        
        using var db = DbFactory.CreateDbContext();

        var newOperation = new OperationPea
        {
        };

        // INSERT dans la base
        db.OperationsPea.Add(newOperation);
        await db.SaveChangesAsync();

        // EF met √† jour automatiquement newRule.Id üëç
        operationsPea.Add(newOperation);
    }

    private async Task RefreshOnChange()
    {
        operationsPea = await PeaService.GetAllOperationsAsync();

        // üî• Important : on repasse sur le thread UI
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // üî• Toujours se d√©sabonner pour √©viter les fuites m√©moire
        DbSelector.OnChange -= RefreshOnChange;
    }

}