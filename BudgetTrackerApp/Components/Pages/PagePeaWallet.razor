@page "/peawallet"
@inject FinanceService FinanceService
@inject PeaService PeaService
@inject ISnackbar Snackbar
@using BudgetTrackerApp.Models
@using BudgetTrackerApp.Data.Services
@using MudBlazor
@using MudBlazor.Charts
@using static BudgetTrackerApp.Data.Services.FinanceService


<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Class="mr-2" />
        Historique de mon Portefeuille (PEA)
    </MudText>
</MudContainer>

@if (ChartSeries.Any())
{
    <MudSelect T="string" Label="Sélectionnez une Valeur" @bind-Value="ValeurSelectionnee" @bind-Value:after="OnChartVisuChanged"">

        @foreach (var valeur in ValeursPossibles)
        {
            <MudSelectItem Value="valeur">@valeur</MudSelectItem>
        }

    </MudSelect>
    <MudTimeSeriesChart ChartSeries="@ChartSeries" Height="600px" Width="100%" TimeLabelFormat="MM/yy"
        TimeLabelSpacing="@(TimeSpan.FromDays(364))" ChartOptions="@_options" DataMarkerTooltipTimeLabelFormat="MMM yyyy" >
    </MudTimeSeriesChart>
}
else
{
    <MudText>Chargement des données ou aucune donnée disponible.</MudText>
}

@foreach (var item in listeCumulsPea)
{
    <MudText>
        @item.Date - @item.AchatCumules - @item.ValeurTotale
    </MudText>
}

@code {
    private List<CumulPea> listeCumulsPea = new();
    private List<TimeSeriesChartSeries> ChartSeries { get; set; } = new();

    // 1. Propriété pour stocker la valeur choisie par l'utilisateur
    private string ValeurSelectionnee { get; set; } = "Gains";

    // 2. Collection fixe des options disponibles
    private List<string> ValeursPossibles = new List<string> { "Achat & Valeurs", "Gains" };

    private ChartOptions _options = new ChartOptions
        {
            // Ces propriétés viennent de ChartOptions :
            YAxisLines = false,
            YAxisTicks = 100,
            MaxNumYAxisTicks = 10,
            YAxisRequireZeroPoint = true,
            XAxisLines = false,
            LineStrokeWidth = 1,
            
            // Ajoutez ici les options spécifiques au TimeSeries (Format, etc.) :
            // Ces propriétés existent sur ChartOptions lorsqu'elles sont utilisées avec MudTimeSeriesChart
            // et qu'elles sont gérées par la classe de base.
            YAxisFormat = "C2",           // Pour le format des valeurs de l'axe Y (devise)
        };

    protected override async Task OnInitializedAsync()
    {
        var tickers = await FinanceService.GetTickerList();
        if (tickers == null)
            return;

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        Snackbar.Configuration.VisibleStateDuration = 3000;

        foreach (var ticker in tickers)
        {
            var result = await FinanceService.UpdateCachedStockPrice(ticker.Ticker, ticker.OldestDate, false);
            if (result == null || result.Status == UpdateStatus.NotAttempted)
                continue;

            var sev = result.Status == UpdateStatus.Success ? Severity.Success
            : result.Status == UpdateStatus.Failed ? Severity.Error
            : Severity.Normal;

            Snackbar.Add($"{ticker.Ticker} : {result.Message}", sev);
        }

        listeCumulsPea = await PeaService.CalculerCumul();
        ProcessChartData();
    }


    private void OnChartVisuChanged()
    {
        ProcessChartData();
    }
    

    private void ProcessChartData()
    {
        ChartSeries.Clear();

        if (!listeCumulsPea.Any())
            return;

        var data = listeCumulsPea.OrderBy(c => c.Date).ToList();

        if (ValeurSelectionnee == "Gains")
        {
            var gains = new TimeSeriesChartSeries
            {
                Name = "Gains",
                Data = data.Select(d => new TimeSeriesChartSeries.TimeValue(d.Date, Math.Round((double)(d.ValeurTotale - d.AchatCumules),2))).ToList(),
                DataMarkerTooltipTitleFormat = "{{X_VALUE}} : {{Y_VALUE}} €"
            };

            ChartSeries.Add(gains);
        }
        else
        {
            // Série "Cumul Achat"
            var achat = new TimeSeriesChartSeries
            {
                Name = "Cumul Achat",
                Data = data.Select(d => new TimeSeriesChartSeries.TimeValue(d.Date, Math.Round((double)d.AchatCumules,2))).ToList(),
                DataMarkerTooltipTitleFormat = "{{X_VALUE}} : {{Y_VALUE}} "
            };

            // Série "Valeur Totale"
            var valeur = new TimeSeriesChartSeries
            {
                Name = "Valeur Totale",
                Data = data.Select(d => new TimeSeriesChartSeries.TimeValue(d.Date, Math.Round((double)d.ValeurTotale,2))).ToList(),
                DataMarkerTooltipTitleFormat = "{{X_VALUE}} : {{Y_VALUE}} "
            };

            ChartSeries.Add(achat);
            ChartSeries.Add(valeur);
        }


    }
}