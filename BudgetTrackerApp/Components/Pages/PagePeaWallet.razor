@page "/peawallet"
@inject FinanceService FinanceService
@using System.Globalization
@using BudgetTrackerApp.Models
@using MudBlazor
@using static FinanceService
@using MudBlazor.Utilities
@using MudBlazor.Services
@using MudBlazor.Extensions

@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">

    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Class="mr-2" />
        Historique de mon Portefeuille (PEA)
    </MudText>

    <MudDivider Class="my-4" />

</MudContainer>

@code {
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var _listTicker = await FinanceService.GetTickerList();

        if (_listTicker == null)
            return;

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        Snackbar.Configuration.VisibleStateDuration = 3000;
        Severity snackbarSeverity = Severity.Normal;

        foreach (var ticker in _listTicker)
        {
            var updateStocksValuesResult = await FinanceService.UpdateCachedStockPrice(ticker.Ticker, ticker.OldestDate, false);

            if (updateStocksValuesResult == null || updateStocksValuesResult.Status == UpdateStatus.NotAttempted)
                continue;

            if (updateStocksValuesResult.Status == UpdateStatus.Success)
                snackbarSeverity = Severity.Success;
            else if (updateStocksValuesResult.Status == UpdateStatus.Failed)
                snackbarSeverity = Severity.Error;

            Snackbar.Add($"{ticker.Ticker} : {updateStocksValuesResult.Message}", snackbarSeverity);
        }

        _isLoading = false;
    }
}