@page "/peawallet"
@inject FinanceService FinanceService
@inject PeaService PeaService
@inject ISnackbar Snackbar
@using BudgetTrackerApp.Models
@using BudgetTrackerApp.Data.Services
@using MudBlazor
@using MudBlazor.Charts
@using static BudgetTrackerApp.Data.Services.FinanceService

<MudContainer MaxWidth="MaxWidth.Large" Class="my-8">
    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Class="mr-2" />
        Historique de mon Portefeuille (PEA)
    </MudText>
</MudContainer>

@if (ChartSeries.Any())
{
    <MudTimeSeriesChart ChartSeries="@ChartSeries" Height="600px" TimeLabelFormat="MM/yy" TimeLabelSpacing="@(TimeSpan.FromDays(364))" />
}
else
{
    <MudText>Chargement des données ou aucune donnée disponible.</MudText>
}

@foreach (var item in listeCumulsPea)
{
    <MudText>
        @item.Date - @item.AchatCumules - @item.ValeurTotale
    </MudText>
}

@code {
    private List<CumulPea> listeCumulsPea = new();
    private List<TimeSeriesChartSeries> ChartSeries { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var tickers = await FinanceService.GetTickerList();
        if (tickers == null)
            return;

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        Snackbar.Configuration.VisibleStateDuration = 3000;

        foreach (var ticker in tickers)
        {
            var result = await FinanceService.UpdateCachedStockPrice(ticker.Ticker, ticker.OldestDate, false);
            if (result == null || result.Status == UpdateStatus.NotAttempted)
                continue;

            var sev = result.Status == UpdateStatus.Success ? Severity.Success
                      : result.Status == UpdateStatus.Failed ? Severity.Error
                      : Severity.Normal;

            Snackbar.Add($"{ticker.Ticker} : {result.Message}", sev);
        }

        listeCumulsPea = await PeaService.CalculerCumul();
        ProcessChartData();
    }

    private void ProcessChartData()
    {
        ChartSeries.Clear();

        if (!listeCumulsPea.Any())
            return;

        var data = listeCumulsPea.OrderBy(c => c.Date).ToList();

        Console.WriteLine($"data = {data.Count}");

        // Série "Cumul Achat"
        var achat = new TimeSeriesChartSeries
        {
            Name = "Cumul Achat",
            Data = data.Select(d => new TimeSeriesChartSeries.TimeValue(d.Date, (double)d.AchatCumules)).ToList()
        };

        Console.WriteLine($"Cumul achat ok");
        // Série "Valeur Totale"
        var valeur = new TimeSeriesChartSeries
        {
            Name = "Valeur Totale",
            Data = data.Select(d => new TimeSeriesChartSeries.TimeValue(d.Date, (double)d.ValeurTotale)).ToList()
        };
        Console.WriteLine($"Valeur totale ok");

        ChartSeries.Add(achat);
        Console.WriteLine($"Add(achat) ok");
        ChartSeries.Add(valeur);
        Console.WriteLine($"Add(valeur) ok");
    }
}
