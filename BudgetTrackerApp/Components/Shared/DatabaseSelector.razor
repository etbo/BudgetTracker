@using BudgetTrackerApp.Services
@using MudBlazor
@rendermode InteractiveServer

@namespace BudgetTrackerApp.Components
@inject DatabaseSelectorService DbSelector
@implements IDisposable

<MudSelect T="string"
           Value="@DbSelector.CurrentDatabase"
           ValueChanged="OnDatabaseChangedAsync"
           AdornmentColor="Color.Inherit"
           Variant="@Variant.Text"
           AdornmentIcon="@Icons.Material.Filled.Storage"
           Adornment="@Adornment.Start"
           FitContent="true"
           Class="mud-select-white-override"
           >
    <MudSelectItem Value="@("Production")">DB Production</MudSelectItem>
    <MudSelectItem Value="@("Test")">DB Test</MudSelectItem>
</MudSelect>

<style>
/* Définissez la classe ici si vous ne voulez pas un fichier CSS externe.
   Si ce code se trouve dans un composant enfant (par exemple, un .razor), 
   MudBlazor peut ne pas l'appliquer correctement si la classe est définie 
   après le composant. Il est préférable de le mettre en début de composant 
   ou dans un fichier CSS.
*/
.mud-select-white-override .mud-input-adornment-icon,
.mud-select-white-override .mud-input-label,
.mud-select-white-override .mud-select-input {
    color: white !important;
}
</style>

@code {

    protected override void OnInitialized()
    {
        // Abonnement propre
        DbSelector.OnChange += RefreshUI;
    }

    private async Task RefreshUI()
    {
        // Utilisation de async Task pour correspondre à Func<Task>? de DatabaseSelectorService
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnDatabaseChangedAsync(string selected)
    {
        // L'argument 'selected' est directement la valeur (string) de l'option MudSelectItem sélectionnée.
        if (!string.IsNullOrEmpty(selected))
        {
            await DbSelector.SetDatabase(selected);
        }
    }

    // Le pattern IDisposable est nécessaire pour l'abonnement
    public void Dispose()
    {
        DbSelector.OnChange -= RefreshUI;
    }

    // La méthode IsSelected n'est plus nécessaire car MudSelect gère la sélection via 'Value'.
}