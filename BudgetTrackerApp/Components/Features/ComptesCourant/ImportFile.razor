@using System.Globalization
@using System.Text
@using BudgetTrackerApp.Components.Pages
@using BudgetTrackerApp.Data
@using BudgetTrackerApp.Services
@using Microsoft.EntityFrameworkCore
@inject BudgetTrackerApp.Data.Services.CompteCourantService CompteService
@inject IDbContextFactory<AppDbContext> DbFactory

@inject DatabaseSelectorService DbSelector

@rendermode InteractiveServer


<MudText Typo="Typo.h4" Class="my-8">Import</MudText>

@* <InputFile OnChange="HandleFileSelected" /> *@

<MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="UploadFiles" Class="d-inline-block">
    <ActivatorContent>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
            Charger des fichiers
        </MudButton>
    </ActivatorContent>
</MudFileUpload>

<MudTable Items="@fichiersImports" >
    <HeaderContent>
        <MudTh>
            NomDuFichier
        </MudTh>
        <MudTh>
            Résultat
        </MudTh>
        <MudTh>
            Banque
        </MudTh>
        <MudTh>
            Opérations Lues/Importées
        </MudTh>
        <MudTh>
            Dates
        </MudTh>
        <MudTh>
            Durée
        </MudTh>
        <MudTh>
            Date
        </MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Date">@context.NomDuFichier</MudTd>
        <MudTd DataLabel="Date">
            @if (@context.IsSuccessful)
                {
                    <MudAlert Severity="Severity.Success">Succès</MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Error">@context.MsgErreur</MudAlert>
                }
        </MudTd>
        <MudTd DataLabel="Date">@context.Parser</MudTd>
        <MudTd DataLabel="Date">@context.NombreOperationsAjoutees / @context.NombreOperationsLus</MudTd>
        <MudTd DataLabel="Date">@context.DateMin au @context.DateMax</MudTd>
        <MudTd DataLabel="Date">@context.TempsDeTraitement.TotalMilliseconds.ToString("N0") ms</MudTd>
        <MudTd DataLabel="Description">@context.DateTraitement</MudTd>
    </RowTemplate>
</MudTable>


@code {


    private List<FichierTraite> fichiersImports = new List<FichierTraite>();

    public record FichierTraite(
    string NomDuFichier,
    bool IsSuccessful,
    string MsgErreur,
    string Database,
    int NombreOperationsLus,
    int NombreOperationsAjoutees,
    string? Parser,
    string? DateMin,
    string? DateMax,
    TimeSpan TempsDeTraitement,
    DateTime DateTraitement
    );

    IList<IBrowserFile> _files = new List<IBrowserFile>(); // Champ de classe
    private async Task UploadFiles(IReadOnlyList<IBrowserFile> newFiles) // Paramètre local
    {

        foreach (var file in newFiles)
        {
            var startTime = DateTime.Now;
            var isSuccessful = false;
            var messageErreur = "";
            int operationsCount = 0;
            int operationsAdded = 0;
            string datePlusAncienne = "";
            string datePlusRecente = "";
            IBanqueParser? parser = null;

            using var db = DbFactory.CreateDbContext();
            string database = db.Database.GetDbConnection().DataSource;

            try
            {
                // Ouverture du fichier
                using var originalStream = file.OpenReadStream();
                using var memoryStream = new MemoryStream();
                await originalStream.CopyToAsync(memoryStream);

                // Remettre la position au début
                memoryStream.Position = 0;

                // Lecture

                string? textContent = null;
                if (file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
                {
                    using var reader = new StreamReader(memoryStream, Encoding.UTF8);
                    textContent = await reader.ReadToEndAsync();

                    // remettre le stream au début si tu veux le réutiliser
                    memoryStream.Position = 0;
                }

                // Création du Contexte pour le parser
                var ctx = new ParserInputContext
                {
                    FileStream = memoryStream,
                    TextContent = textContent,
                    FileName = file.Name,
                    ContentType = file.ContentType
                };

                // Appel de la factory pour trouver le bon parser
                parser = ParserFactory.GetParser(ctx);

                if (parser == null)
                {
                    throw new Exception("Impossible de reconnaitre la banque");
                }

                // Parsing du fichier
                List<Data.OperationCC>? Operations = parser.Parse(ctx);

                operationsCount = Operations.Count;

                if ((Operations == null) || !Operations.Any())
                {
                    throw new Exception("Aucune opération trouvée");
                }

                // Charger tous les hash existants dans la base
                var existingHashes = db.Operations
                .Select(o => o.Hash)
                .ToHashSet();

                // Filtrer les nouvelles opérations (dont le Hash n'est pas dans la BDD)
                var filteredOps = Operations
                .Where(op => !existingHashes.Contains(op.Hash))
                .ToList();


                // 3️⃣ Ajouter les opérations filtrées dans la base
                db.Operations.AddRange(filteredOps);
                db.SaveChanges();

                operationsAdded = filteredOps.Count;
                datePlusAncienne = filteredOps.Min(o => o.Date) ?? "-";
                datePlusRecente = filteredOps.Max(o => o.Date) ?? "-";

                isSuccessful = true;
            }
            catch (Exception e)
            {
                messageErreur = $"{e.Message}";
            }

            var tempsEcoule = DateTime.Now - startTime;

            // Création de l'objet pour stocker les métadonnées
            var resultat = new FichierTraite(
            NomDuFichier: file.Name,
            MsgErreur: messageErreur,
            Database: database,
            NombreOperationsLus: operationsCount,
            IsSuccessful: isSuccessful,
            NombreOperationsAjoutees: operationsAdded,
            TempsDeTraitement: tempsEcoule,
            DateMin: datePlusAncienne,
            DateMax: datePlusRecente,
            Parser: parser?.BankName,
            DateTraitement: DateTime.Now
            );

            fichiersImports.Insert(0, resultat);
        }

        StateHasChanged(); // Pour rafraîchir l'interface utilisateur
    }


}